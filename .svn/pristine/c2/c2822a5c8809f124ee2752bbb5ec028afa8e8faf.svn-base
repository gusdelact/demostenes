ALTER TABLE 
	CNBV_OFICIO 
ADD 
   (
      TIENE_ACUSE		VARCHAR2(1)	NULL,
      TIPO_CASO			VARCHAR2(2)	NULL,
      CVE_ESTATUS		VARCHAR2(8 BYTE) NULL,
      CVE_ESTATUS_PEND	VARCHAR2(8 BYTE) NULL
   );
   
ALTER TABLE
   CNBV_OFICIO
MODIFY
   (
   TX_DIRECCION VARCHAR2(100 BYTE) NULL,
   TX_GERENCIA VARCHAR2(100 BYTE) NULL,
   TX_ATN_NOM VARCHAR2(100 BYTE) NULL,
   TX_ATN_PUE VARCHAR2(100 BYTE) NULL,
   CVE_AUTORIDAD VARCHAR(6 BYTE) NULL
   )
;
   
COMMENT ON COLUMN CNBV_OFICIO.TIENE_ACUSE IS 'Marca para indicar si tiene o no acuse';
COMMENT ON COLUMN CNBV_OFICIO.TIPO_CASO IS 'Indica si la respuesta fue: (PO positiva, NE negativa)';

CREATE INDEX I02_CNBV_OFICIO ON CNBV_OFICIO (F_RECEPCION);
CREATE INDEX I03_CNBV_OFICIO ON CNBV_OFICIO (FH_ENVIO);
CREATE INDEX I04_CNBV_OFICIO ON CNBV_OFICIO (CVE_ESTATUS);
CREATE INDEX I05_CNBV_OFICIO ON CNBV_OFICIO (CVE_ESTATUS_PEND);

CREATE OR REPLACE TRIGGER TRG_UPD_CNBV_OFICIO
AFTER UPDATE
ON CNBV_OFICIO REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
/******************************************************************************
   NAME:       TRG_UPD_CNBV_OFICIO  SEPT 2007
   MARA4356 PARA REGISTRAR EL ARCHIVO EN EL QUE SE ENVIO LA RESPUESTA A LA CNBV
******************************************************************************/
VLNum_docto CNBV_DOCUMENTO.NUM_DOCTO%TYPE;
BEGIN
-- *****
-- SI CAMBIA DE TERMINADO A ENVIADO A L SITI
  IF :OLD.sit_oficio='TE' AND :NEW.SIT_OFICIO='EN' AND (:OLD.TIPO_CASO IS NULL OR :OLD.TIPO_CASO = 'NE') THEN
     DBMS_OUTPUT.PUT_LINE('ENTRO DE TE ==> EN ');
     UPDATE CNBV_RESPUESTA
     SET   SIT_ENVIO = 'EN'
     WHERE TRIM(NUM_OFICIO)  = TRIM(:NEW.NUM_OFICIO)
     AND   TRIM(TIPO_OFICIO) = TRIM(:NEW.TIPO_OFICIO);

     BEGIN
       SELECT NVL(MAX(num_docto)+ 1,1) INTO VLNum_docto
       FROM CNBV_DOCUMENTO
       WHERE num_oficio = :NEW.num_oficio AND TIPO_OFICIO=:NEW.TIPO_OFICIO;
       EXCEPTION
       WHEN OTHERS THEN VLNum_docto:=1;
     END;

     INSERT INTO CNBV_DOCUMENTO
         (num_oficio,
          tipo_oficio,
          cve_docto,
          nom_docto,
          fh_alta,
          cve_usu_alta,
          num_docto)
     VALUES
         (:NEW.num_oficio,
          :NEW.tipo_oficio,
          'EN',
          :NEW.TX_NOM_ARCH,SYSDATE,
          :NEW.CVE_USU_ENVIO,
          VLNum_docto);
   END IF;
-- *****
-- SI CAMBIA DE ENVIADO A TERMINADO
   IF :OLD.sit_oficio='EN' AND :NEW.SIT_OFICIO='TE' AND (:OLD.TIPO_CASO IS NULL OR :OLD.TIPO_CASO = 'NE') THEN
     UPDATE CNBV_RESPUESTA
     SET   SIT_ENVIO = 'NE'
     WHERE TRIM(NUM_OFICIO)  = TRIM(:NEW.NUM_OFICIO)
     AND   TRIM(TIPO_OFICIO) = TRIM(:NEW.TIPO_OFICIO);

     DELETE FROM CNBV_DOCUMENTO
     WHERE TRIM(NUM_OFICIO)  = TRIM(:NEW.NUM_OFICIO)
     AND   TRIM(TIPO_OFICIO) = TRIM(:NEW.TIPO_OFICIO)
     AND   CVE_DOCTO = 'EN';
   END IF;
   EXCEPTION
   WHEN OTHERS THEN
       RAISE;
END TRG_UPD_CNBV_OFICIO;
/